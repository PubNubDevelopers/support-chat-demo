{"version":3,"sources":["core/components/token_manager.js"],"names":["config","cbor","_config","_cbor","_initializeTokens","_userTokens","_spaceTokens","_userToken","undefined","_spaceToken","token","tokenObject","parseToken","resources","users","Object","keys","forEach","id","spaces","patterns","length","_setToken","tokens","setToken","tokenDef","result","user","space","type","permissions","permissionsResult","create","read","write","manage","tokenString","parsed","decodeToken","userResourcePermissions","res","usr","spaceResourcePermissions","spc","userPatternPermissions","pat","spacePatternPermissions","version","v","timestamp","t","ttl","userResources","spaceResources","extractPermissions","userPatterns","spacePatterns","meta","signature","sig"],"mappings":"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","sourcesContent":["/* @flow */\nimport Config from './config';\nimport {\n  TokensDefinition,\n  GetTokensInput,\n  GrantTokenOutput,\n} from '../flow_interfaces';\n\nexport default class {\n  _config: Config;\n\n  _cbor: any;\n\n  _userTokens: { [string]: string};\n  _spaceTokens: { [string]: string};\n\n  _userToken: ?string;\n  _spaceToken: ?string;\n\n  constructor(config: Config, cbor: any) {\n    this._config = config;\n    this._cbor = cbor;\n    this._initializeTokens();\n  }\n\n  _initializeTokens() {\n    this._userTokens = {};\n    this._spaceTokens = {};\n\n    this._userToken = undefined;\n    this._spaceToken = undefined;\n  }\n\n  _setToken(token: string) {\n    let tokenObject: GrantTokenOutput = this.parseToken(token);\n\n    if (tokenObject && tokenObject.resources) {\n      if (tokenObject.resources.users) {\n        Object.keys(tokenObject.resources.users).forEach((id) => {\n          this._userTokens[id] = token;\n        });\n      }\n\n      if (tokenObject.resources.spaces) {\n        Object.keys(tokenObject.resources.spaces).forEach((id) => {\n          this._spaceTokens[id] = token;\n        });\n      }\n    }\n\n    if (tokenObject && tokenObject.patterns) {\n      if (tokenObject.patterns.users && Object.keys(tokenObject.patterns.users).length > 0) {\n        this._userToken = token;\n      }\n\n      if (tokenObject.patterns.spaces && Object.keys(tokenObject.patterns.spaces).length > 0) {\n        this._spaceToken = token;\n      }\n    }\n  }\n\n  setToken(token: string) {\n    if (token && token.length > 0) {\n      this._setToken(token);\n    }\n  }\n\n  setTokens(tokens: string[]) {\n    if (tokens && tokens.length && typeof tokens === 'object') {\n      tokens.forEach((token) => {\n        this.setToken(token);\n      });\n    }\n  }\n\n  getTokens(tokenDef: GetTokensInput): TokensDefinition {\n    let result: TokensDefinition = {\n      users: {},\n      spaces: {}\n    };\n\n    if (tokenDef) {\n      if (tokenDef.user) {\n        result.user = this._userToken;\n      }\n\n      if (tokenDef.space) {\n        result.space = this._spaceToken;\n      }\n\n      if (tokenDef.users) {\n        tokenDef.users.forEach((user) => {\n          result.users[user] = this._userTokens[user];\n        });\n      }\n\n      if (tokenDef.space) {\n        tokenDef.spaces.forEach((space) => {\n          result.spaces[space] = this._spaceTokens[space];\n        });\n      }\n    } else {\n      if (this._userToken) {\n        result.user = this._userToken;\n      }\n\n      if (this._spaceToken) {\n        result.space = this._spaceToken;\n      }\n\n      Object.keys(this._userTokens).forEach((user) => {\n        result.users[user] = this._userTokens[user];\n      });\n\n      Object.keys(this._spaceTokens).forEach((space) => {\n        result.spaces[space] = this._spaceTokens[space];\n      });\n    }\n\n    return result;\n  }\n\n  getToken(type: string, id?: string) {\n    let result;\n\n    if (id) {\n      if (type === 'user') {\n        result = this._userTokens[id];\n      } else if (type === 'space') {\n        result = this._spaceTokens[id];\n      }\n    } else if (type === 'user') {\n      result = this._userToken;\n    } else if (type === 'space') {\n      result = this._spaceToken;\n    }\n\n    return result;\n  }\n\n  extractPermissions(permissions: number) {\n    let permissionsResult = {\n      create: false,\n      read: false,\n      write: false,\n      manage: false,\n      delete: false,\n    };\n\n    /* eslint-disable */\n\n    if ((permissions & 16) === 16) {\n      permissionsResult.create = true;\n    }\n\n    if ((permissions & 8) === 8) {\n      permissionsResult.delete = true;\n    }\n\n    if ((permissions & 4) === 4) {\n      permissionsResult.manage = true;\n    }\n    \n    if ((permissions & 2) === 2) {\n      permissionsResult.write = true;\n    }\n    \n    if ((permissions & 1) === 1) {\n      permissionsResult.read = true;\n    }\n    \n    /* eslint-enable */\n\n    return permissionsResult;\n  }\n\n  parseToken(tokenString: string): GrantTokenOutput {\n    let parsed = this._cbor.decodeToken(tokenString);\n\n    if (parsed !== undefined) {\n      let userResourcePermissions = Object.keys(parsed.res.usr);\n      let spaceResourcePermissions = Object.keys(parsed.res.spc);\n      let userPatternPermissions = Object.keys(parsed.pat.usr);\n      let spacePatternPermissions = Object.keys(parsed.pat.spc);\n\n      let result: GrantTokenOutput  = {\n        version: parsed.v,\n        timestamp: parsed.t,\n        ttl: parsed.ttl\n      };\n\n      let userResources = userResourcePermissions.length > 0;\n      let spaceResources = spaceResourcePermissions.length > 0;\n\n      if (userResources  || spaceResources) {\n        result.resources = {};\n\n        if (userResources) {\n          result.resources.users = {};\n          userResourcePermissions.forEach((id) => {\n            result.resources.users[id] = this.extractPermissions(parsed.res.usr[id]);\n          });\n        }\n\n        if (spaceResources) {\n          result.resources.spaces = {};\n          spaceResourcePermissions.forEach((id) => {\n            result.resources.spaces[id] = this.extractPermissions(parsed.res.spc[id]);\n          });\n        }\n      }\n\n      let userPatterns = userPatternPermissions.length > 0;\n      let spacePatterns = spacePatternPermissions.length > 0;\n\n      if (userPatterns  || spacePatterns) {\n        result.patterns = {};\n\n        if (userPatterns) {\n          result.patterns.users = {};\n          userPatternPermissions.forEach((id) => {\n            result.patterns.users[id] = this.extractPermissions(parsed.pat.usr[id]);\n          });\n        }\n\n        if (spacePatterns) {\n          result.patterns.spaces = {};\n          spacePatternPermissions.forEach((id) => {\n            result.patterns.spaces[id] = this.extractPermissions(parsed.pat.spc[id]);\n          });\n        }\n      }\n\n      if (Object.keys(parsed.meta).length > 0) {\n        result.meta = parsed.meta;\n      }\n\n      result.signature = parsed.sig;\n\n      return result;\n    } else {\n      return undefined;\n    }\n  }\n\n  clearTokens() {\n    this._initializeTokens();\n  }\n}\n"],"file":"token_manager.js"}