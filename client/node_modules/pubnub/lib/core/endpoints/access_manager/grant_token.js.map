{"version":3,"sources":["core/endpoints/access_manager/grant_token.js"],"names":["getOperation","operationConstants","PNAccessManagerGrantToken","extractPermissions","permissions","permissionsResult","create","manage","write","read","prepareMessagePayload","modules","incomingParams","ttl","resources","patterns","meta","params","channels","groups","users","spaces","Object","keys","forEach","user","space","validateParams","config","subscribeKey","publishKey","secretKey","length","postURL","usePost","getRequestTimeout","getTransactionTimeout","isAuthSupported","prepareParams","postPayload","handleResponse","response","token","data"],"mappings":"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","sourcesContent":["/* @flow */\n\nimport { GrantTokenInput, GrantTokenObject, ModulesInject } from '../../flow_interfaces';\nimport operationConstants from '../../constants/operations';\n\nexport function getOperation(): string {\n  return operationConstants.PNAccessManagerGrantToken;\n}\n\nexport function extractPermissions(permissions: GrantTokenObject) {\n  let permissionsResult = 0;\n\n  /* eslint-disable */\n\n  if (permissions.create) {\n    permissionsResult |= 16;\n  }\n\n  if (permissions.delete) {\n    permissionsResult |= 8;\n  }\n\n  if (permissions.manage) {\n    permissionsResult |= 4;\n  }\n\n  if (permissions.write) {\n    permissionsResult |= 2;\n  }\n\n  if (permissions.read) {\n    permissionsResult |= 1;\n  }\n\n  /* eslint-enable */\n\n  return permissionsResult;\n}\n\nfunction prepareMessagePayload(modules, incomingParams) {\n  const { ttl, resources, patterns, meta } = incomingParams;\n  const params = {\n    ttl: 0,\n    permissions: {\n      resources: {\n        channels: {},\n        groups: {},\n        users: {},\n        spaces: {}\n      },\n      patterns: {\n        channels: {},\n        groups: {},\n        users: {},\n        spaces: {}\n      },\n      meta: {}\n    }\n  };\n\n  if (resources) {\n    const { users, spaces } = resources;\n\n    if (users) {\n      Object.keys(users).forEach((user) => {\n        params.permissions.resources.users[user] = extractPermissions(users[user]);\n      });\n    }\n\n    if (spaces) {\n      Object.keys(spaces).forEach((space) => {\n        params.permissions.resources.spaces[space] = extractPermissions(spaces[space]);\n      });\n    }\n  }\n\n  if (patterns) {\n    const { users, spaces } = patterns;\n\n    if (users) {\n      Object.keys(users).forEach((user) => {\n        params.permissions.patterns.users[user] = extractPermissions(users[user]);\n      });\n    }\n\n    if (spaces) {\n      Object.keys(spaces).forEach((space) => {\n        params.permissions.patterns.spaces[space] = extractPermissions(spaces[space]);\n      });\n    }\n  }\n\n  if (ttl || ttl === 0) {\n    params.ttl = ttl;\n  }\n\n  if (meta) {\n    params.permissions.meta = meta;\n  }\n\n  return params;\n}\n\nexport function validateParams(\n  modules: ModulesInject,\n  incomingParams: GrantTokenInput\n) {\n  let { config } = modules;\n\n  if (!config.subscribeKey) return 'Missing Subscribe Key';\n  if (!config.publishKey) return 'Missing Publish Key';\n  if (!config.secretKey) return 'Missing Secret Key';\n\n  if (!incomingParams.resources && !incomingParams.patterns) return 'Missing either Resources or Patterns.';\n\n  if (\n    (\n      (incomingParams.resources) &&\n      (!incomingParams.resources.users || Object.keys(incomingParams.resources.users).length === 0) &&\n      (!incomingParams.resources.spaces || Object.keys(incomingParams.resources.spaces).length === 0)\n    ) ||\n    (\n      (incomingParams.patterns) &&\n      (!incomingParams.patterns.users || Object.keys(incomingParams.patterns.users).length === 0) &&\n      (!incomingParams.patterns.spaces || Object.keys(incomingParams.patterns.spaces).length === 0)\n    )\n  ) {\n    return 'Missing values for either Resources or Patterns.';\n  }\n}\n\nexport function postURL(modules: ModulesInject): string {\n  let { config } = modules;\n  return `/v3/pam/${config.subscribeKey}/grant`;\n}\n\nexport function usePost() {\n  return true;\n}\n\nexport function getRequestTimeout({ config }: ModulesInject): number {\n  return config.getTransactionTimeout();\n}\n\nexport function isAuthSupported(): boolean {\n  return false;\n}\n\nexport function prepareParams(): Object {\n  return {};\n}\n\nexport function postPayload(\n  modules: ModulesInject,\n  incomingParams: GrantTokenInput\n): Object {\n  return prepareMessagePayload(modules, incomingParams);\n}\n\nexport function handleResponse(\n  modules: ModulesInject,\n  response: Object\n): string {\n  let token = response.data.token;\n\n  return token;\n}\n"],"file":"grant_token.js"}