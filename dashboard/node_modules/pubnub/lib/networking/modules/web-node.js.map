{"version":3,"sources":["networking/modules/web-node.js"],"names":["log","req","_pickLogger","console","window","start","Date","getTime","timestamp","toISOString","logger","url","qs","on","res","now","elapsed","timestampDone","text","xdr","superagentConstruct","endpoint","callback","_config","logVerbosity","use","proxy","_modules","call","keepAlive","timeout","end","err","resp","parsedResponse","status","error","operation","statusCode","response","errorData","JSON","parse","e","category","_detectErrorCategory","message","service","get","params","superagent","getStandardOrigin","set","headers","query","post","body","send","patch","del"],"mappings":"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","sourcesContent":["/* @flow */\n/* global window */\n\nimport superagent from 'superagent';\nimport {\n  EndpointDefinition,\n  StatusAnnouncement,\n} from '../../core/flow_interfaces';\n\nfunction log(req: Object) {\n  let _pickLogger = () => {\n    if (console && console.log) return console; // eslint-disable-line no-console\n    if (window && window.console && window.console.log) return window.console;\n    return console;\n  };\n\n  let start = new Date().getTime();\n  let timestamp = new Date().toISOString();\n  let logger = _pickLogger();\n  logger.log('<<<<<'); // eslint-disable-line no-console\n  logger.log(`[${timestamp}]`, '\\n', req.url, '\\n', req.qs); // eslint-disable-line no-console\n  logger.log('-----'); // eslint-disable-line no-console\n\n  req.on('response', (res) => {\n    let now = new Date().getTime();\n    let elapsed = now - start;\n    let timestampDone = new Date().toISOString();\n\n    logger.log('>>>>>>'); // eslint-disable-line no-console\n    logger.log(\n      `[${timestampDone} / ${elapsed}]`,\n      '\\n',\n      req.url,\n      '\\n',\n      req.qs,\n      '\\n',\n      res.text\n    ); // eslint-disable-line no-console\n    logger.log('-----'); // eslint-disable-line no-console\n  });\n}\n\nfunction xdr(\n  superagentConstruct: superagent,\n  endpoint: EndpointDefinition,\n  callback: Function\n): Object {\n  if (this._config.logVerbosity) {\n    superagentConstruct = superagentConstruct.use(log);\n  }\n\n  if (this._config.proxy && this._modules.proxy) {\n    superagentConstruct = this._modules.proxy.call(this, superagentConstruct);\n  }\n\n  if (this._config.keepAlive && this._modules.keepAlive) {\n    superagentConstruct = this._modules.keepAlive(superagentConstruct);\n  }\n\n  return superagentConstruct.timeout(endpoint.timeout).end((err, resp) => {\n    let parsedResponse;\n    let status: StatusAnnouncement = {};\n    status.error = err !== null;\n    status.operation = endpoint.operation;\n\n    if (resp && resp.status) {\n      status.statusCode = resp.status;\n    }\n\n    if (err) {\n      if (err.response && err.response.text && !this._config.logVerbosity) {\n        try {\n          status.errorData = JSON.parse(err.response.text);\n        } catch (e) {\n          status.errorData = err;\n        }\n      } else {\n        status.errorData = err;\n      }\n      status.category = this._detectErrorCategory(err);\n      return callback(status, null);\n    }\n\n    try {\n      parsedResponse = JSON.parse(resp.text);\n    } catch (e) {\n      status.errorData = resp;\n      status.error = true;\n      return callback(status, null);\n    }\n\n    if (\n      parsedResponse.error &&\n      parsedResponse.error === 1 &&\n      parsedResponse.status &&\n      parsedResponse.message &&\n      parsedResponse.service\n    ) {\n      status.errorData = parsedResponse;\n      status.statusCode = parsedResponse.status;\n      status.error = true;\n      status.category = this._detectErrorCategory(status);\n      return callback(status, null);\n    } else if (parsedResponse.error && parsedResponse.error.message) {\n      status.errorData = parsedResponse.error;\n    }\n\n    return callback(status, parsedResponse);\n  });\n}\n\nexport function get(\n  params: Object,\n  endpoint: EndpointDefinition,\n  callback: Function\n): superagent {\n  let superagentConstruct = superagent\n    .get(this.getStandardOrigin() + endpoint.url)\n    .set(endpoint.headers)\n    .query(params);\n  return xdr.call(this, superagentConstruct, endpoint, callback);\n}\n\nexport function post(\n  params: Object,\n  body: string,\n  endpoint: EndpointDefinition,\n  callback: Function\n): superagent {\n  let superagentConstruct = superagent\n    .post(this.getStandardOrigin() + endpoint.url)\n    .query(params)\n    .set(endpoint.headers)\n    .send(body);\n  return xdr.call(this, superagentConstruct, endpoint, callback);\n}\n\nexport function patch(\n  params: Object,\n  body: string,\n  endpoint: EndpointDefinition,\n  callback: Function\n): superagent {\n  let superagentConstruct = superagent\n    .patch(this.getStandardOrigin() + endpoint.url)\n    .query(params)\n    .set(endpoint.headers)\n    .send(body);\n  return xdr.call(this, superagentConstruct, endpoint, callback);\n}\n\nexport function del(\n  params: Object,\n  endpoint: EndpointDefinition,\n  callback: Function\n): superagent {\n  let superagentConstruct = superagent\n    .delete(this.getStandardOrigin() + endpoint.url)\n    .set(endpoint.headers)\n    .query(params);\n  return xdr.call(this, superagentConstruct, endpoint, callback);\n}\n"],"file":"web-node.js"}